<%= render 'header' %>

<div class="row">
  <div class="panel panel-default">
    <div class="panel-heading hidden-print">
      <h3 class="panel-title">
        <%= content_tag(:span, '', class: 'glyphicon glyphicon-eye-open') %> 
        Viendo prescripción <%= @prescription.ambulatoria? ? "ambulatoria" : "crónica" %>
        <%= link_to prescriptions_path, class: 'btn pull-right close-btn',
          :title => 'Cerrar', :'data-placement'=>'top', :'data-toggle'=>'tooltip' do %>
          <%= content_tag(:span, '', class: 'glyphicon glyphicon-remove') %>
        <% end %>
        <%= link_to '',class:'btn pull-right print-btn', :onclick => 'window.print();return false;',
          :title => 'Imprimir', :'data-placement'=>'top', :'data-toggle'=>'tooltip' do %>
          <%= content_tag(:span, "", class: "glyphicon glyphicon-print") %>
        <% end %>
      </h3>
    </div>
    <div id=tittle-print class="visible-print-block"><%= current_user.establishment_name %></div>
    <div class="panel-body" id="panel-body-new">
      <% if @prescription.ambulatoria? %>
        <div class="row">
          <div class='col-md-6 col-xs-6'>
            <strong>Doctor:</strong>
            <%= @prescription.professional.full_name %>
            <br><hr>
            <strong>Paciente:</strong>
            <%= @prescription.patient.fullname%>
          </div>
          <div class='col-md-6 col-xs-6'>
            <div class='row'>
              <div class='col-md-3 col-xs-3'>    
                <strong>Recetada:</strong><br>
                <%= @prescription.prescribed_date.strftime("%d/%m/%Y")%>
              </div>
              <div class='col-md-3 col-xs-3'>
                <strong>Vencimiento:</strong><br>
                <%= @prescription.expiry_date.strftime("%d/%m/%Y")%>
              </div>
              <div class='col-md-3 col-xs-3'>
                <strong>Código:</strong>
                <%= @prescription.remit_code %>
              </div>
            </div>
            <hr>
            <strong>Observaciones:</strong>
            <%= @prescription.observation.present? ? @prescription.observation : 'Sin observaciones' %>
          </div>
        </div>
        <hr>
        <!-- Insumos a dispensar -->
        <table class="table table-hover table-condensed">
          <thead>
            <tr>
              <th>Cód Ins</th>
              <th>Insumo</th>
              <th>Dosis</th>
              <th><%= @prescription.dispensada? ? 'Entregado' : 'A entregar' %></th>
              <th>Lote</th>
              <th>Laboratorio</th>
              <th>Vencimiento</th>
              <th>Observaciones</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% @prescription.quantity_ord_supply_lots.each do |qosl| %>
              <tr>
                <td>
                  <%= qosl.supply_id %>
                </td>
                <td>
                  <%= qosl.supply_name %>
                </td>
                <td>
                  <%= qosl.treatment_duration %> <%= 'Día'.pluralize(qosl.treatment_duration) %>
                </td>
                <td>
                  <%= qosl.daily_dose %> <%= qosl.unity.pluralize(qosl.requested_quantity) %>
                </td>
                <td>
                  <%= qosl.requested_quantity %> <%= qosl.unity.pluralize(qosl.requested_quantity) %>
                </td>
                <td>
                  <%= qosl.delivered_quantity %> <%= qosl.unity.pluralize(qosl.delivered_quantity) %>
                </td>
                <% if qosl.sector_supply_lot.present? %>
                  <td>
                    <%= qosl.sector_supply_lot.lot_code %>
                  </td>
                  <td>
                    <%= qosl.sector_supply_lot.laboratory %>
                  </td>
                  <td>
                    <% if qosl.supply.needs_expiration %>
                      <%= qosl.sector_supply_lot.expiry_date.present? ? qosl.sector_supply_lot.expiry_date.strftime("%d/%m/%Y") : "Sin asignar" %>
                    <% else %>
                      No vence
                    <% end %>
                  </td>
                <% else %>
                  <td>Sin lote</td><td>----</td><td>----</td>
                <% end %>
                <td><%= qosl.provider_observation.present? ? qosl.provider_observation : '----' %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% elsif @prescription.cronica? %>
        <div class="row">
          <div class='col-md-6 col-xs-6'>
            <strong>Doctor:</strong>
            <%= @prescription.professional.full_name %>
            <br><hr>
            <strong>Paciente:</strong>
            <%= @prescription.patient.fullname%>
          </div>
          <div class='col-md-6 col-xs-6'>
            <div class='row'>
              <div class='col-md-3 col-xs-3'>    
                <strong>Recetada:</strong><br>
                <%= @prescription.prescribed_date.strftime("%d/%m/%Y")%>
              </div>
              <div class='col-md-3 col-xs-3'>
                <strong>Código:</strong>
                <%= @prescription.remit_code %>
              </div>
            </div>
            <hr>
            <strong>Observaciones:</strong>
            <%= @prescription.observation.present? ? @prescription.observation : 'Sin observaciones' %>
          </div>
        </div>
        <br><br><br><br>
        <div class='row'>
          <div class='col-md-12' style='margin-top: -50px;'>
            <ul class='nav nav-tabs nav-justified'>
              <li class='active'>
                <a data-toggle='tab' href='#supplies'>
                  <span class="glyphicon glyphicon-barcode"></span>
                  Insumos
                  <span class="badge"><%= @prescription.quantity_ord_supply_lots.sin_entregar.count %></span>
                </a>
              </li>
              <li>
                <a data-toggle='<%= @prescription.cronic_dispensations.to_set.count > 0 ? 'tab' : '' %>' href='#dispensations'>
                  <span class="glyphicon glyphicon-send"></span>
                  Dispensaciones
                  <span class="badge"><%= @prescription.cronic_dispensations.to_set.count %>/<%= @prescription.times_dispensation %></span>
                </a>
              </li>
              <li>
                <a data-toggle='tab' href='#last_movements'>
                  <span class="glyphicon glyphicon-transfer"></span>
                  Movimientos
                  <span class="badge"><%= @prescription.movements.count %></span>
                </a>
              </li>
            </ul>
          </div>
        </div>
        <div class="col-md-12">
          <div class="tab-content">
            <!-- Insumos a dispensar -->
            <div id='supplies' class='tab-pane fade in active'>
              <table class="table table-hover table-condensed">
                <thead>
                  <tr>
                    <th>Cód Ins</th>
                    <th>Insumo</th>
                    <th>Consumo/mes</th>
                    <th>Observaciones</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @prescription.quantity_ord_supply_lots.sin_entregar.each do |qosl| %>
                    <tr>
                      <td>
                        <%= qosl.supply_id %>
                      </td>
                      <td>
                        <%= qosl.supply_name %>
                      </td>
                      <td>
                        <%= qosl.requested_quantity %> <%= qosl.unity.pluralize(qosl.requested_quantity) %>
                      </td>
                      <td><%= qosl.provider_observation.present? ? qosl.provider_observation : '----' %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            <!-- Insumos a dispensar -->
            <% cronic_dispensations = @prescription.cronic_dispensations.order(created_at: :desc).to_set %>
            <div id='dispensations' class='tab-pane fade'>
              <div role="tabpanel">
                <div class="col-sm-2">
                  <ul class="nav nav-pills brand-pills nav-stacked" role="tablist">
                    <% i = 0 %>
                    <% cronic_dispensations.each do |cd| %>
                      <li role="presentation" class="brand-nav <%= i == 0 ? "active" : ""%>">
                        <a href="#tab<%= cd.id %>" aria-controls="tab<%= cd.id %>" class="text-right" role="tab" data-toggle="tab">
                          <span class="badge"><%= cronic_dispensations.count - i %>°</span> &nbsp;
                          <%= cd.created_at.strftime("%d/%m/%Y") %>
                          <%= cd.created_at.strftime("%H:%M")%>
                        </a>
                      </li>
                      <% i += 1 %>
                    <% end %>
                  </ul>
                </div>
                <div class="col-sm-10">
                  <div class="tab-content">
                    <% i = 0 %>
                    <% cronic_dispensations.each.each do |cd| %>
                      <div role="tabpanel" class="tab-pane <%= i == 0 ? "active" : ""%>" id="tab<%= cd.id %>">
                        <table class="table table-hover table-condensed">
                          <thead>
                            <tr>
                              <th>Cód Ins</th>
                              <th>Insumo</th>
                              <th>Consumo/mes</th>
                              <th>Entregado</th>
                              <th>Lote</th>
                              <th>Observaciones</th>
                              <th></th>
                            </tr>
                          </thead>
                          <tbody>
                            <% cd.quantity_ord_supply_lots.each do |qosl| %>
                              <tr>
                                <td>
                                  <%= qosl.supply_id %>
                                </td>
                                <td>
                                  <%= qosl.supply_name %>
                                </td>
                                <td>
                                  <%= qosl.requested_quantity %> <%= qosl.unity.pluralize(qosl.requested_quantity) %>
                                </td>
                                <td>
                                  <%= qosl.delivered_quantity %> <%= qosl.unity.pluralize(qosl.delivered_quantity) %>
                                </td>
                                <td>
                                  <%= qosl.sector_supply_lot.lot_code %>
                                </td>
                                <td><%= qosl.provider_observation.present? ? qosl.provider_observation : '----' %></td>
                              </tr>
                            <% end %>
                          </tbody>
                        </table>  
                      </div>
                      <% i += 1 %>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
            <div id='last_movements' class='tab-pane fade'>
              <!-- Tabla de movimientos -->
              <%= render '/shared/movements_table', order: @prescription %>
            </div> <!-- End last movements tab pane -->
          </div>
        </div>
      <% end %>
    </div>
    <div class="panel-footer text-right hidden-print">
      <%= link_to 'Volver', prescriptions_path, class: "btn" %>
      <% if policy(@prescription).return_status? %>
        <a href="#return-confirm" data-id="<%= @prescription.id %>" class="return-confirm btn btn-warning">
          <%= content_tag(:span, "", class: "glyphicon glyphicon-retweet") %>
          Retornar
        </a>
      <% end %>
      <% if policy(@prescription).edit? %>
        <%= link_to edit_prescription_path(@prescription), :"data-turbolinks" => false,
          class: "btn btn-warning" do %>
          <%= content_tag(:span, "", class: "glyphicon glyphicon-edit") %>
          Auditar
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<% if policy(@prescription).return_status? %>
  <!-- Modal para retornar estado -->
  <div class="modal" id="return-confirm">
    <div class="modal-dialog">
      <div class="modal-content panel-warning">
        <div class="modal-header panel-heading">
          <a class="close" data-dismiss="modal">×</a>
          <h3><%= content_tag(:span, "", class: "glyphicon glyphicon-retweet") %> Retornar a <%= prev_status = Prescription.statuses.key(@prescription.status_before_type_cast - 1).split('_').map(&:capitalize).join(' ') %></h3>
        </div>
        <div class="modal-body">
          <p>Seguro que desea retornar la prescripción a <%= prev_status %>?</p>
          <p>Se devolverán todos los insumos a tu stock.</p>
        </div>
        <div class="modal-footer text-right">
          <a href="#" data-dismiss="modal" class="btn">Cancelar</a>
          <%= link_to 'Confirmar', return_status_prescription_path, method: :get, :class => 'btn btn-warning' %>
        </div>
      </div>
    </div>
  </div>
<% end %>