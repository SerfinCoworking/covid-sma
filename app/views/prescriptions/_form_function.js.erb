$('#prescription_date_received').datetimepicker({ format: 'DD/MM/YYYY HH:mm' });

$('.chosen-select').chosen({
    allow_single_deselect: true,
    no_results_text: 'No se encontró el resultado',
    width: '270px'});


 //Se crea un diccionario de los suministros con sus respectivas cantidades en stock.
<% @supplt_lots = SupplyLot.all %>
var quantityToSupply = {
<% @supplt_lots.each do |sup_lot| %>
  "<%=sup_lot.id%>": {
  quantity : "<%=sup_lot.quantity%>"
},
<% end %>
};

$(document).on("change", "#prescription_quantity_supply_lots_attributes_0_supply_lot_id", function(){
  var country = $(this).val();

  console.log("Cambio el cod");
  $.ajax({
    url: "/users/new",
    method: "GET",
    dataType: "json",
    data: {country: country},
    error: function (xhr, status, error) {
      console.error('AJAX Error: ' + status + error);
    },
    success: function (response) {
      console.log(response);
      var cities = response["cities"];
      $("#city select").empty();

      $("#city select").append('<option>Select city</option>');
      for(var i=0; i< cities.length; i++){
        $("#city select").append('<option value="' + cities[i]["id"] + '">' + cities[i]["name"] + '</option>');
      }
    }
  });
});

//Función para establecer el máximo al campo "Cantidad" de cada suministro.
function setMaxQuantitySupplyLot(idSelect){
  var sup_lots = $('#quantity-supply_lots');
  var supplyCant = sup_lots.find('.nested-fields').size();
  var idNum = idSelect.substr(idSelect.length - 1); //Se toma el último caracter del id, que es lo unico que varía.
  var supply_id =  $("#chosen-supply-"+idNum+" option:selected").val(); //Se aloja el id de la opcion seleccionada para acceder al diccionario.

  if($("#chosen-supply-"+idNum+" option:selected").val() != 0){
    document.getElementById("quantity-supply-"+idNum).setAttribute("required", true);
    document.getElementById("quantity-supply-"+idNum).disabled = false;
    document.getElementById("quantity-supply-"+idNum).setAttribute("max", quantityToSupply[supply_id].quantity);
  }else{
    document.getElementById("quantity-supply-"+idNum).setAttribute("required", false);
    document.getElementById("quantity-supply-"+idNum).disabled = true;
  }

  //Loop para deshabilitar el suministro seleccionado en el resto y asi no repetirlo.
  for(i = 1; i <= supplyCant; i++){
    var selectedValue = $("#chosen-supply-"+i+" option:selected").val();
    for(x = 1; x <= supplyCant; x++){
      if(x != i){
        $("#chosen-supply-"+x).find('option[value="'+ selectedValue +'"]:not(:selected)').attr('disabled','disabled');
        $("#chosen-supply-"+x).trigger("chosen:updated");
      }
    }
  }
}

jQuery(function() {
  var termTemplate = "<span class='ui-autocomplete-term'>%s</span>";

  return $('#professional').autocomplete({
    source: $('#professional').data('autocomplete-source'),
    minLength: 3,
    open: function (e, ui) {
      var acData = $(this).data('ui-autocomplete');
      acData
      .menu
      .element
      .find('li')
      .each(function () {
          var me = $(this);
          var keywords = acData.term.split(' ').join('|');
          me.html(me.text().replace(new RegExp("(" + keywords + ")", "gi"), '<b><u>$1</u></b>'));
      });
    },
    select:
    function (event, ui) {
      $("#professional_id").val(ui.item.id);
    }
  }).each(function() {
      $(this).autocomplete("widget").insertAfter($("#dialog").parent());
  })
});

jQuery(function() {
  var termTemplate = "<span class='ui-autocomplete-term'>%s</span>";

  return $('#patient').autocomplete({
    source: $('#patient').data('autocomplete-source'),
    minLength: 3,
    open: function (e, ui) {
      var acData = $(this).data('ui-autocomplete');
      acData
      .menu
      .element
      .find('li')
      .each(function () {
          var me = $(this);
          var keywords = acData.term.split(' ').join('|');
          me.html(me.text().replace(new RegExp("(" + keywords + ")", "gi"), '<b><u>$1</u></b>'));
      });
    },
    select:
    function (event, ui) {
      $("#patient_id").val(ui.item.id);
    }
  }).each(function() {
      $(this).autocomplete("widget").insertAfter($("#dialog").parent());
  })
});
