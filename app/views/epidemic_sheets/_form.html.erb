
<div class="card fixed-custom-card">
  <div class="card-header <%= @epidemic_sheet.new_record? ? 'bg-primary text-white' : 'bg-warning' %> d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center ml-2">
      <%= fa_icon (@epidemic_sheet.new_record? ?  "plus" : "edit")%>
      <h5 class="card-title mb-0 ml-2">
        <%= @epidemic_sheet.new_record? ? "Nueva ficha epidemiológica" : "Editando ficha epidemiológica" %>
      </h5>
    </div>
    <%= link_to :back, class: @epidemic_sheet.new_record? ? 'btn text-white' : 'btn' do %>
      <%= fa_icon "times" %>
    <% end %>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-8 border-right">
        <%= simple_form_for @epidemic_sheet, html: { role: 'check-modified' } do |f| %>
          <%= f.error_notification %>

          <h5 class="border-bottom">Definición de caso</h5>
          <%= f.simple_fields_for :case_definition do |case_d| %>
            <div class="d-flex justify-content-between">
              <%# CASO %>
              <div class="flex-fill">
                <%= case_d.input :case_type, label: 'Caso', include_blank: false,
                  collection: CaseDefinition.case_types.keys.map { |ct| [ct.humanize, ct] },
                  :value_method => :second,
                  :input_html => {
                    required: true,
                    include_blank: false,
                    class: 'selectpicker custom-select-pick case-select',
                    "data-width"=>"100%",
                    "data-size"=>"10",
                    value: "#{ case_d.object.case_type }"
                  }
                %>
              </div>
              <%# MÉTODO %>
              <div class="flex-fill <%= case_d.object.sospechoso? ? 'invisible' : 'visible' %> diagnostic-method">
                <%= case_d.input :diagnostic_method_id, label: 'Método',
                  collection: @diagnostic_methods.map {|method|  [method.name, method.id ]},
                  :input_html => {
                    required: true,
                    include_blank: false,
                    class: 'selectpicker custom-select-pick',
                    "data-width"=>"100%",
                    "data-size"=>"10",
                    "title"=>"Seleccionar método"
                  }
                %>
              </div>
            </div>
          <% end %> <!-- End case definition -->

          <h5 class="border-bottom">Paciente</h5>
          <div class="d-flex flex-row">
            <div class="custom-input-group w-40 pr-1">
              <%= f.input :patient_fake, as: :fake, class: 'form-control',
                label: 'DNI',
                placeholder: 'DNI',
                required: true,
                readonly: f.object.new_record? ? "" : true,
                :input_html => {
                  id: 'patient-dni',
                  data: { autocomplete_source: get_by_dni_patients_path },
                  value: "#{if f.object.patient.present?; f.object.patient.dni; end }",
                }
              %>
              <div class="with-loading">
                <%= fa_icon 'spinner', class: "fa-spin"%>
              </div>
            </div>

          </div>

          <div class="accordion" id="accordion1">
            <%= render "form_patient", :form_builder => f, :patient => @patient %>
          </div>

          <h5 class="border-bottom">Información clínica</h5>
          <div class="d-flex justify-content-between">
            <div class="flex-fill p-1">
              <%= f.input :init_symptom_date, as: :string, label: "Fecha Inicio", html5: true, required: true,
                :input_html => {
                  required: true,
                  class: "form-control prescribed-date",
                  autocomplete: "off",
                  value: "#{f.object.new_record? ? DateTime.now.strftime("%d/%m/%Y") : f.object.init_symptom_date.strftime("%d/%m/%Y")}"
                }
              %>
            </div>
            <div class="flex-fill p-1">
              <%= f.input :epidemic_week, label: 'Semana epidemiológica' %>
            </div>
            <div class="flex-fill p-1">
              <%= f.input :clinic_location, label: 'Situación', include_blank: false,
                collection: EpidemicSheet.clinic_locations.keys.map { |ct| [ct.humanize, ct] },
                :value_method => :second,
                :input_html => {
                  required: true,
                  include_blank: false,
                  class: 'selectpicker custom-select-pick case-select',
                  "data-width"=>"100%",
                  "data-size"=>"10",
                  value: "#{ f.object.clinic_location }"
                }
              %>
            </div>
          </div>
          <h5 class="border-bottom">Signos y sintomas</h5>
          <div class="d-flex justify-content-between">
            <div class="flex-fill">
              <div class="custom-control custom-switch">
                <%= f.check_box :presents_symptoms, class: "custom-control-input", id: "customSwitch1"   %>
                <label class="custom-control-label" for="customSwitch1">Presenta síntomas </label>
              </div>
            </div>
            <div class="flex-fill">
              <%= f.input :symptoms_observations, label: 'Observaciones' %>
            </div>
          </div>
          <h5 class="border-bottom">Enfermedades previas</h5>
          <div class="d-flex justify-content-between">
            <div class="flex-fill">
              <div class="custom-control custom-switch">
                <%= f.check_box :previous_symptoms, class: "custom-control-input", id: "customSwitch2"   %>
                <label class="custom-control-label" for="customSwitch2">Enfermedades previas </label>
              </div>
            </div>
            <div class="flex-fill">
              <%= f.input :prev_symptoms_observations, label: 'Observaciones' %>
            </div>
          </div>
        <% end %>
      </div>
      <div class="col-4">

      </div>
    </div>
  </div>

  <div class="card-footer d-flex justify-content-end">
    <%= link_to 'Volver', epidemic_sheets_path, class: 'btn mr-2' %>
    <button type='submit' name='commit' class='btn btn-success' form="<%= @epidemic_sheet.new_record? ? 'new_epidemic_sheet' : 'edit_epidemic_sheet_' + @epidemic_sheet.id.to_s %>">
      <%= fa_icon 'save' %> Guardar
    </button>
  </div>
</div>

<div class="modal fade" tabindex="-1" id="patient-found-modal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ficha existente</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="patient-data">
          <span>
            El paciente 
          </span>
          <span id="patient-fullname"></span>
          <span>posee una ficha.</span>
          <div>
            <span>Dni: </span>
            <span id="patient-dni"></span>
          </div>
          <div>
            <span>Registrado en el establecimiento: </span>
            <span id="establishment"></span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Buscar otro paciente</button>
        <button type="button" class="btn btn-primary">Ir a ficha</button>
      </div>
    </div>
  </div>
</div>